<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, viewport-fit=cover">
    <title>PimpPong | MOBILE OPTIMIZED</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&display=swap');
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { 
            margin: 0; padding: 0; 
            width: 100%; 
            height: 100vh; 
            height: 100dvh; /* Nutzt den dynamischen Viewport für Android/iOS */
            background: #000; color: #ffd700; 
            font-family: 'Orbitron', sans-serif; 
            overflow: hidden; touch-action: none; 
        }
        canvas { display: block; width: 100%; height: 100%; }
        .header { position: absolute; top: 0; width: 100%; padding: 15px; background: rgba(0,0,0,0.8); z-index: 100; border-bottom: 2px solid #ffd700; text-align: center; pointer-events: none; }
        #leaderboard { position: absolute; bottom: 15px; left: 15px; z-index: 20; background: rgba(0, 0, 0, 0.7); padding: 10px; border-radius: 8px; border: 1px solid rgba(255, 215, 0, 0.4); width: 170px; pointer-events: none; }
        table { width: 100%; font-size: 0.6rem; color: #fff; border-collapse: collapse; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; }
        #popup { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #0a0a0a; border: 3px solid #ffd700; padding: 30px; z-index: 1100; border-radius: 20px; width: 85%; max-width: 380px; text-align: center; }
        .main-btn { background: #ffd700; color: #000; border: none; padding: 15px; font-weight: 900; width: 100%; cursor: pointer; border-radius: 10px; font-family: 'Orbitron'; font-size: 1rem; margin-top: 10px; }
        #event-msg { font-size: 0.7rem; color: #00ff66; height: 15px; margin-bottom: 5px; font-weight: bold; }
    </style>
</head>
<body>

<div class="header">
    <div id="event-msg"></div>
    <div style="font-size: 1.1rem;">SCORE: <span id="score">0</span> | BEST: <span id="high">0</span></div>
</div>

<canvas id="gameCanvas"></canvas>

<div id="leaderboard">
    <table><tbody id="leader-rows"></tbody></table>
</div>

<div class="overlay" id="overlay"></div>
<div id="popup">
    <h2 id="status-text">GAME OVER</h2>
    <h1 id="final-score" style="font-size: 3.5rem; margin: 10px 0; color: #ffd700;">0</h1>
    <div id="input-container"></div>
    <button id="actionBtn" class="main-btn">TRY AGAIN</button>
</div>

<script>
const SUPABASE_URL = 'https://jmknzhsmlwqwzxguxfor.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impta256aHNtbHdxd3p4Z3V4Zm9yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzMTk4ODQsImV4cCI6MjA4Mzg5NTg4NH0.ZKZ-lTZmc6HoLoAC-MuyejyQCL4WM9ZMgEU_x-yH_L0';
const PADDLE_URL = 'https://i.ibb.co/s06v3BX/image-8.png';
const EGG_URL = 'https://i.ibb.co/VYbXg81b/16220.png';

const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const paddleImg = new Image(); paddleImg.src = PADDLE_URL;
const eggImg = new Image(); eggImg.src = EGG_URL;

let score = 0, gameActive = true, globalTopScores = [];
let lastTime = performance.now(), accumulator = 0, dt = 1000/60;
let shake = 0, particles = [], powerUps = [];
let paddle = { x: 0, y: 0, w: 140, h: 40, targetW: 140 };
let ball = { x: 200, y: 200, r: 20, dx: 6, dy: 6, bossHP: 0 };
let slowMo = 0, wind = 0, wobble = 0, collisionCooldown = 0;

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    updatePaddleHeight();
    
    // Check ob Mobilgerät
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    
    // Setze Paddle-Position höher auf Android, damit der Körper sichtbar ist
    paddle.y = isMobile ? canvas.height - 220 : canvas.height - 180;
    paddle.x = canvas.width / 2 - paddle.w / 2;
}

function updatePaddleHeight() {
    if(paddleImg.complete && paddleImg.naturalWidth > 0) {
        paddle.h = paddle.w * (paddleImg.naturalHeight / paddleImg.naturalWidth);
    }
}

window.addEventListener('resize', resize);
paddleImg.onload = resize;

async function loadScores() {
    try {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/leaderboard?select=wallet,score&order=score.desc&limit=3`, {
            headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
        });
        const data = await res.json();
        if (data) {
            globalTopScores = data;
            document.getElementById("leader-rows").innerHTML = data.map((e,i)=>`<tr><td>${i+1}.</td><td>${e.wallet.substring(0,6)}...</td><td align="right">${e.score}</td></tr>`).join('');
            if(data[0]) document.getElementById("high").innerText = data[0].score;
        }
    } catch(e) {}
}

function createParticles(x, y, color) {
    for(let i=0; i<8; i++) {
        particles.push({ x, y, dx: (Math.random()-0.5)*8, dy: (Math.random()-0.5)*8, life: 1, c: color });
    }
}

function checkCollision(pX, pY, pW, pH) {
    if (collisionCooldown > 0) return false;
    let closestX = Math.max(pX, Math.min(ball.x, pX + pW));
    let closestY = Math.max(pY + 15, Math.min(ball.y, pY + pH));
    let dx = ball.x - closestX;
    let dy = ball.y - closestY;

    if ((dx * dx + dy * dy) < (ball.r * ball.r)) {
        collisionCooldown = 12;
        shake = 5; 
        createParticles(ball.x, ball.y, ball.bossHP > 0 ? '#ff4444' : '#ffd700');
        
        if (ball.bossHP > 0) {
            ball.bossHP--;
            if (ball.bossHP > 0) {
                ball.dy = -Math.abs(ball.dy);
                document.getElementById("event-msg").innerText = "BOSS: " + ball.bossHP + " HP!";
                return false;
            } else {
                score += 5; ball.r = 20;
                document.getElementById("event-msg").innerText = "BOSS DEFEATED! +5";
            }
        }
        ball.dy = -Math.abs(ball.dy) * 1.05;
        ball.y = pY + 15 - ball.r + 5;
        return true;
    }
    return false;
}

function update() {
    if(!gameActive) return;
    if (collisionCooldown > 0) collisionCooldown--;
    if (slowMo > 0) slowMo--;
    
    if (score >= 40 && Math.random() < 0.01) wind = (Math.random() - 0.5) * 0.4;
    
    if (score > 0 && score % 50 === 0 && ball.bossHP === 0) {
        ball.bossHP = 3; ball.r = 55;
        document.getElementById("event-msg").innerText = "BOSS CHALLENGE!";
    }

    const currentDt = slowMo > 0 ? 0.4 : 1;
    ball.x += (ball.dx + wind) * currentDt;
    ball.y += ball.dy * currentDt;
    wobble += 0.15;

    if(ball.x < ball.r || ball.x > canvas.width - ball.r) {
        ball.dx *= -1; ball.x = ball.x < ball.r ? ball.r : canvas.width - ball.r;
    }
    if(ball.y < ball.r) ball.dy = Math.abs(ball.dy);

    paddle.w += (paddle.targetW - paddle.w) * 0.1;
    updatePaddleHeight();

    if (Math.random() < 0.005 && score > 10) {
        powerUps.push({ x: Math.random()*(canvas.width-40), y: -20, type: Math.random() > 0.5 ? 'WIDE' : 'SLOW' });
    }

    powerUps.forEach((p, i) => {
        p.y += 4;
        if (p.y > paddle.y && p.y < paddle.y + paddle.h && p.x > paddle.x && p.x < paddle.x + paddle.w) {
            if (p.type === 'WIDE') { paddle.targetW = 240; setTimeout(() => paddle.targetW = 140, 7000); }
            else { slowMo = 250; }
            document.getElementById("event-msg").innerText = p.type + " ACTIVE!";
            powerUps.splice(i, 1);
        } else if (p.y > canvas.height) powerUps.splice(i, 1);
    });

    if (checkCollision(paddle.x, paddle.y, paddle.w, paddle.h)) {
        score++;
        document.getElementById("score").innerText = score;
    }
    if(ball.y > canvas.height) showPopup();
}

function render() {
    ctx.globalAlpha = 1.0;
    ctx.shadowBlur = 0;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    ctx.save();
    if (shake > 0) { 
        ctx.translate((Math.random()-0.5)*shake, (Math.random()-0.5)*shake); 
        shake *= 0.85; 
    }

    particles.forEach((p, i) => {
        ctx.globalAlpha = p.life; 
        ctx.fillStyle = p.c;
        ctx.fillRect(p.x, p.y, 3, 3); p.x += p.dx; p.y += p.dy; p.life -= 0.03;
        if(p.life <= 0) particles.splice(i, 1);
    });
    ctx.globalAlpha = 1.0;

    powerUps.forEach(p => {
        ctx.fillStyle = p.type === 'WIDE' ? '#00ccff' : '#00ff66';
        ctx.beginPath(); ctx.arc(p.x, p.y, 12, 0, Math.PI*2); ctx.fill();
    });

    if(paddleImg.complete) {
        ctx.drawImage(paddleImg, paddle.x, paddle.y, paddle.w, paddle.h);
    }

    ctx.save();
    ctx.translate(ball.x, ball.y); 
    ctx.rotate(wobble * 0.5);
    if (ball.bossHP > 0) { 
        ctx.shadowBlur = 20; 
        ctx.shadowColor = "red"; 
    }
    ctx.drawImage(eggImg, -ball.r, -ball.r, ball.r*2, ball.r*2);
    ctx.restore();
    
    ctx.restore();
}

function gameLoop(now) {
    accumulator += now - lastTime; lastTime = now;
    while(accumulator >= dt) { update(); accumulator -= dt; }
    render(); if(gameActive) requestAnimationFrame(gameLoop);
}

function showPopup() {
    gameActive = false;
    document.getElementById("overlay").style.display = "block";
    document.getElementById("popup").style.display = "block";
    document.getElementById("final-score").innerText = score;
    const currentHigh = parseInt(document.getElementById("high").innerText) || 0;
    const isNew = score > 0 && (score > currentHigh || globalTopScores.length < 3);
    
    if (isNew) {
        document.getElementById("status-text").innerText = "NEW RECORD!";
        document.getElementById("input-container").innerHTML = '<input type="text" id="walletInput" placeholder="SOLANA WALLET" style="width:100%; padding:12px; margin:10px 0; background:#111; color:#fff; border:1px solid #ffd700; border-radius:8px;">';
        document.getElementById("actionBtn").innerText = "SUBMIT";
        document.getElementById("actionBtn").onclick = async () => {
            const val = document.getElementById("walletInput").value;
            if(val.length > 5) {
                await fetch(`${SUPABASE_URL}/rest/v1/leaderboard`, {
                    method: 'POST', headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ wallet: val, score: score })
                });
                window.location.reload();
            }
        };
    } else {
        document.getElementById("actionBtn").onclick = () => window.location.reload();
    }
}

function handleInput(e) {
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    paddle.x = clientX - paddle.w / 2;
    if (paddle.x < 0) paddle.x = 0;
    if (paddle.x + paddle.w > canvas.width) paddle.x = canvas.width - paddle.w;
}

window.addEventListener("mousemove", handleInput);
window.addEventListener("touchstart", handleInput);
window.addEventListener("touchmove", (e) => { handleInput(e); e.preventDefault(); }, {passive:false});

resize();
loadScores(); 
requestAnimationFrame(gameLoop);
</script>
</body>
</html>
