<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, viewport-fit=cover">
    <title>PimpPong | WALLET AUTH</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&display=swap');
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; touch-action: none; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100dvh; background: #000; color: #ffd700; font-family: 'Orbitron', sans-serif; overflow: hidden; }
        canvas { display: block; width: 100%; height: 100%; background: #000; }
        .header { position: absolute; top: 0; width: 100%; padding: 15px; background: rgba(0,0,0,0.8); z-index: 100; border-bottom: 2px solid #ffd700; text-align: center; pointer-events: none; display: flex; justify-content: space-around; align-items: center; width: 100%; }
        #leaderboard { position: absolute; bottom: 15px; left: 15px; z-index: 20; background: rgba(0, 0, 0, 0.7); padding: 8px; border-radius: 8px; border: 1px solid rgba(255, 215, 0, 0.4); width: 180px; }
        table { width: 100%; font-size: 0.55rem; color: #fff; border-collapse: collapse; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; }
        #popup { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #0a0a0a; border: 3px solid #ffd700; padding: 30px; z-index: 1100; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; }
        .main-btn { background: #ffd700; color: #000; border: none; padding: 15px; font-weight: 900; width: 100%; cursor: pointer; border-radius: 10px; font-family: 'Orbitron'; margin-top: 10px; text-transform: uppercase; transition: 0.2s; }
        .main-btn:active { transform: scale(0.95); }
        input { background: #111; border: 1px solid #ffd700; color: #ffd700; padding: 12px; width: 100%; border-radius: 8px; font-family: monospace; margin-bottom: 15px; text-align: center; font-size: 0.8rem; }
        .stat-box { display: flex; flex-direction: column; }
        .stat-label { font-size: 0.6rem; color: #aaa; letter-spacing: 1px; }
    </style>
</head>
<body>

<div class="header">
    <div class="stat-box"><span class="stat-label">TIME</span><span id="timer">0s</span></div>
    <div class="stat-box"><span class="stat-label">SCORE</span><span id="score">0</span></div>
    <div class="stat-box"><span class="stat-label">BEST</span><span id="high">0</span></div>
</div>

<canvas id="gameCanvas"></canvas>

<div id="leaderboard">
    <div style="font-size: 0.6rem; margin-bottom: 5px; color: #ffd700;">TOP WALLETS</div>
    <table><tbody id="leader-rows"></tbody></table>
</div>

<div class="overlay" id="overlay"></div>
<div id="popup">
    <h2 id="status-msg" style="margin-top: 0;">GAME OVER</h2>
    <h1 id="final-display" style="font-size: 4rem; color: #ffd700; margin: 10px 0;">0</h1>
    <div id="save-area">
        <div style="font-size: 0.7rem; color: #aaa; margin-bottom: 10px;">ENTER WALLET ADDRESS TO SAVE</div>
        <input type="text" id="walletAddr" placeholder="0x... or Address" spellcheck="false">
        <button id="saveBtn" class="main-btn">SUBMIT SCORE</button>
    </div>
    <button id="retryBtn" class="main-btn" style="display:none; background:#222; color:#fff; border: 1px solid #444;">PLAY AGAIN</button>
</div>

<script>
const SUPABASE_URL = 'https://jmknzhsmlwqwzxguxfor.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impta256aHNtbHdxd3p4Z3V4Zm9yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzMTk4ODQsImV4cCI6MjA4Mzg5NTg4NH0.ZKZ-lTZmc6HoLoAC-MuyejyQCL4WM9ZMgEU_x-yH_L0';
const PADDLE_URL = 'https://i.ibb.co/s06v3BX/image-8.png';
const EGG_URL = 'https://i.ibb.co/VYbXg81b/16220.png';

const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const paddleImg = new Image(); paddleImg.src = PADDLE_URL;
const eggImg = new Image(); eggImg.src = EGG_URL;

const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
const masterGain = audioCtx.createGain(); masterGain.gain.value = 0.2; masterGain.connect(audioCtx.destination);
let beatStarted = false;

function playKick(t) {
    const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
    osc.frequency.setValueAtTime(100, t); osc.frequency.exponentialRampToValueAtTime(0.01, t + 0.3);
    gain.gain.setValueAtTime(0.5, t); gain.gain.exponentialRampToValueAtTime(0.01, t + 0.3);
    osc.connect(gain); gain.connect(masterGain);
    osc.start(t); osc.stop(t + 0.3);
}

function playBeep(f, d) {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
    osc.frequency.setValueAtTime(f, audioCtx.currentTime);
    gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + d);
    osc.connect(gain); gain.connect(masterGain);
    osc.start(); osc.stop(audioCtx.currentTime + d);
}

let score = 0, seconds = 0, gameActive = true, timerInterval;
let paddle = { x: 100, y: 0, w: 140, h: 40, targetW: 140, baseW: 140 };
let ball = { x: 150, y: 150, r: 20, dx: 4, dy: 4, bossHP: 0 };
let shake = 0, slowMo = 0, bgFlash = 0, wobble = 0, bossTriggered = false;

async function loadScores() {
    try {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/leaderboard?select=wallet,score&order=score.desc&limit=5`, {
            headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
        });
        const data = await res.json();
        if (data) {
            document.getElementById("leader-rows").innerHTML = data.map((e,i)=>`<tr><td style="color:#ffd700; width:20px;">${i+1}.</td><td style="font-family:monospace;">${e.wallet.substring(0,4)}...${e.wallet.slice(-3)}</td><td align="right" style="color:#ffd700;">${e.score}</td></tr>`).join('');
            if(data[0]) document.getElementById("high").innerText = data[0].score;
        }
    } catch(e) {}
}

function resize() {
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    paddle.y = canvas.height - 180;
}
window.addEventListener('resize', resize);
paddleImg.onload = resize;

function startTimer() {
    timerInterval = setInterval(() => { if(gameActive) { seconds++; document.getElementById("timer").innerText = seconds + "s"; } }, 1000);
}

function update() {
    if(!gameActive) return;
    if (slowMo > 0) slowMo--;
    if (bgFlash > 0) bgFlash -= 0.02;

    const currentDt = slowMo > 0 ? 0.45 : 1;
    ball.x += (ball.dx + Math.sin(wobble) * 1.5) * currentDt;
    ball.y += ball.dy * currentDt;
    wobble += 0.1;

    if(ball.x <= ball.r || ball.x >= canvas.width - ball.r) { ball.dx *= -1; playBeep(200, 0.05); }
    if(ball.y <= ball.r) ball.dy = Math.abs(ball.dy);

    if (ball.y + ball.r > paddle.y && ball.y - ball.r < paddle.y + paddle.h && ball.x > paddle.x && ball.x < paddle.x + paddle.w) {
        let hitPos = (ball.x - (paddle.x + paddle.w/2)) / (paddle.w/2);
        ball.dx = hitPos * 7 + (Math.random()-0.5)*2;
        ball.dy = -Math.abs(ball.dy) * (score < 60 ? 1.04 : 1.01);
        ball.y = paddle.y - ball.r;
        score++;
        document.getElementById("score").innerText = score;
        if (score !== 50) playBeep(500, 0.05);
        shake = 6;
        if (score === 50 && !bossTriggered) { bossTriggered = true; ball.bossHP = 3; ball.r = 60; bgFlash = 0.5; playBeep(100, 0.5); }
        if (score > 70) paddle.baseW = Math.max(70, paddle.baseW - 1);
        paddle.targetW = paddle.baseW;
    }

    if(ball.y > canvas.height + 50) { gameActive = false; endGame(); }
}

function render() {
    ctx.fillStyle = "#000"; ctx.fillRect(0, 0, canvas.width, canvas.height);
    if (bgFlash > 0) { ctx.fillStyle = `rgba(255, 0, 0, ${bgFlash})`; ctx.fillRect(0,0,canvas.width,canvas.height); }
    ctx.save();
    if (shake > 0) { ctx.translate((Math.random()-0.5)*shake, (Math.random()-0.5)*shake); shake *= 0.8; }
    if(paddleImg.complete) {
        paddle.w += (paddle.targetW - paddle.w) * 0.1;
        paddle.h = paddle.w * (paddleImg.naturalHeight / paddleImg.naturalWidth);
        ctx.drawImage(paddleImg, paddle.x, paddle.y, paddle.w, paddle.h);
    }
    ctx.save();
    ctx.translate(ball.x, ball.y); ctx.rotate(wobble);
    if(ball.bossHP > 0) { ctx.shadowBlur = 15; ctx.shadowColor = "red"; }
    ctx.drawImage(eggImg, -ball.r, -ball.r, ball.r*2, ball.r*2);
    ctx.restore(); ctx.restore();
    if(gameActive) requestAnimationFrame(render);
}

function endGame() {
    clearInterval(timerInterval);
    document.getElementById("overlay").style.display = "block";
    document.getElementById("popup").style.display = "block";
    const finalScore = score + Math.floor(seconds / 2);
    document.getElementById("final-display").innerText = finalScore;

    document.getElementById("saveBtn").onclick = async () => {
        const wallet = document.getElementById("walletAddr").value.trim();
        if (wallet.length < 5) { alert("Please enter a valid wallet address!"); return; }
        
        document.getElementById("status-msg").innerText = "UPLOADING...";
        try {
            await fetch(`${SUPABASE_URL}/rest/v1/leaderboard`, {
                method: 'POST',
                headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ wallet: wallet, score: finalScore })
            });
            document.getElementById("status-msg").innerText = "SUCCESS!";
            document.getElementById("save-area").style.display = "none";
            document.getElementById("retryBtn").style.display = "block";
            loadScores();
        } catch (e) { document.getElementById("status-msg").innerText = "ERROR!"; }
    };
    document.getElementById("retryBtn").onclick = () => window.location.reload();
}

function handleInput(e) {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    if (!beatStarted) { beatStarted = true; startTimer(); setInterval(() => playKick(audioCtx.currentTime), 468); }
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    paddle.x = clientX - paddle.w/2;
}

window.addEventListener("mousemove", handleInput);
window.addEventListener("touchstart", handleInput);
window.addEventListener("touchmove", (e) => { handleInput(e); e.preventDefault(); }, {passive:false});

loadScores(); resize(); render();
setInterval(update, 1000/60);
</script>
</body>
</html>
