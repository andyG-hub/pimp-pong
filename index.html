<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, viewport-fit=cover">
    <title>PimpPong | SILENT TURBO EDITION</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&display=swap');
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; touch-action: none; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100dvh; background: #000; color: #ffd700; font-family: 'Orbitron', sans-serif; overflow: hidden; }
        canvas { display: block; width: 100%; height: 100%; background: #000; }
        .header { position: absolute; top: 0; width: 100%; padding: 10px; background: rgba(0,0,0,0.85); z-index: 100; border-bottom: 2px solid #ffd700; display: flex; justify-content: space-around; align-items: center; }
        #leaderboard { position: absolute; bottom: 15px; left: 15px; z-index: 20; background: rgba(0, 0, 0, 0.7); padding: 8px; border-radius: 8px; border: 1px solid rgba(255, 215, 0, 0.4); width: 180px; }
        table { width: 100%; font-size: 0.55rem; color: #fff; border-collapse: collapse; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; }
        #popup { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #0a0a0a; border: 3px solid #ffd700; padding: 30px; z-index: 1100; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; }
        .main-btn { background: #ffd700; color: #000; border: none; padding: 15px; font-weight: 900; width: 100%; cursor: pointer; border-radius: 10px; font-family: 'Orbitron'; margin-top: 10px; text-transform: uppercase; }
        input { background: #111; border: 1px solid #ffd700; color: #ffd700; padding: 12px; width: 100%; border-radius: 8px; font-family: monospace; margin-bottom: 15px; text-align: center; }
        .stat-val { font-size: 1rem; font-weight: 900; }
    </style>
</head>
<body>

<div class="header">
    <div style="text-align:center;"><span style="font-size:0.5rem;">RESET</span><br><span id="reset-timer" style="font-size:0.6rem; color:#ff3e3e;">--:--:--</span></div>
    <div style="text-align:center;"><span style="font-size:0.5rem; color:#aaa;">TIME</span><br><span id="timer" class="stat-val">0s</span></div>
    <div style="text-align:center;"><span style="font-size:0.5rem; color:#aaa;">SCORE</span><br><span id="score" class="stat-val">0</span></div>
    <div style="text-align:center;"><span style="font-size:0.5rem; color:#aaa;">MODE</span><br><span id="event-msg" style="color:#00ff66; font-size:0.7rem;">NORMAL</span></div>
</div>

<canvas id="gameCanvas"></canvas>

<div id="leaderboard">
    <div style="font-size: 0.6rem; margin-bottom: 5px; color: #ffd700; text-align: center;">TOP 3 WALLETS</div>
    <table><tbody id="leader-rows"></tbody></table>
</div>

<div class="overlay" id="overlay"></div>
<div id="popup">
    <h2 id="status-msg">GAME OVER</h2>
    <h1 id="final-display" style="font-size: 4rem; color: #ffd700; margin: 10px 0;">0</h1>
    <div id="save-area" style="display:none;">
        <div style="color: #00ff66; font-size: 0.8rem; margin-bottom: 10px; font-weight: bold;">TOP 3 RECORD!</div>
        <input type="text" id="walletAddr" placeholder="WALLET ADDRESS">
        <button id="saveBtn" class="main-btn">SAVE SCORE</button>
    </div>
    <button id="retryBtn" class="main-btn">TRY AGAIN</button>
</div>

<script>
const SUPABASE_URL = 'https://jmknzhsmlwqwzxguxfor.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impta256aHNtbHdxd3p4Z3V4Zm9yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzMTk4ODQsImV4cCI6MjA4Mzg5NTg4NH0.ZKZ-lTZmc6HoLoAC-MuyejyQCL4WM9ZMgEU_x-yH_L0';
const PADDLE_URL = 'https://i.ibb.co/s06v3BX/image-8.png';
const EGG_URL = 'https://i.ibb.co/VYbXg81b/16220.png';

const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const paddleImg = new Image(); paddleImg.src = PADDLE_URL;
const eggImg = new Image(); eggImg.src = EGG_URL;

let top3Scores = [];
let score = 0, seconds = 0, gameActive = true, timerInterval, started = false;
let particles = [], powerUps = [];
let paddle = { x: 100, y: 0, w: 140, h: 40, targetW: 140, baseW: 140 };
let ball = { x: 150, y: 150, r: 20, dx: 4, dy: 4, bossHP: 0 };
let shake = 0, slowMo = 0, speedUp = 0, bgFlash = 0, wobble = 0, bossTriggered = false;

function updateResetTimer() {
    const resetDate = new Date("2026-01-21T00:00:00").getTime();
    const diff = resetDate - new Date().getTime();
    const h = Math.max(0, Math.floor(diff / 3600000));
    const m = Math.max(0, Math.floor((diff % 3600000) / 60000));
    const s = Math.max(0, Math.floor((diff % 60000) / 1000));
    document.getElementById("reset-timer").innerText = `${h}h ${m}m ${s}s`;
}
setInterval(updateResetTimer, 1000);

async function loadScores() {
    try {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/leaderboard?select=wallet,score&order=score.desc&limit=3`, {
            headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
        });
        top3Scores = await res.json();
        if (top3Scores) {
            document.getElementById("leader-rows").innerHTML = top3Scores.map((e,i)=>`<tr><td style="color:#ffd700;">${i+1}.</td><td>${e.wallet.substring(0,6)}...</td><td align="right">${e.score}</td></tr>`).join('');
        }
    } catch(e) {}
}

function resize() {
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    paddle.y = canvas.height - 180;
}
window.addEventListener('resize', resize);
paddleImg.onload = resize;

function update() {
    if(!gameActive) return;
    if (slowMo > 0) slowMo--;
    if (speedUp > 0) speedUp--;
    if (bgFlash > 0) bgFlash -= 0.02;

    let currentDt = 1;
    if (slowMo > 0) currentDt = 0.45;
    if (speedUp > 0) currentDt = 1.6;

    ball.x += (ball.dx + Math.sin(wobble) * 1.5) * currentDt;
    ball.y += ball.dy * currentDt;
    wobble += 0.1;

    if(ball.x <= ball.r || ball.x >= canvas.width - ball.r) { ball.dx *= -1; }
    if(ball.y <= ball.r) ball.dy = Math.abs(ball.dy);

    if (ball.y + ball.r > paddle.y && ball.y - ball.r < paddle.y + paddle.h && ball.x > paddle.x && ball.x < paddle.x + paddle.w) {
        let hitPos = (ball.x - (paddle.x + paddle.w/2)) / (paddle.w/2);
        ball.dx = hitPos * 7 + (Math.random()-0.5)*2;
        ball.dy = -Math.abs(ball.dy) * (score < 60 ? 1.04 : 1.01);
        ball.y = paddle.y - ball.r;
        
        score += (speedUp > 0) ? 2 : 1;
        document.getElementById("score").innerText = score;
        
        shake = speedUp > 0 ? 15 : 8;
        for(let i=0; i<8; i++) particles.push({x: ball.x, y: ball.y, dx:(Math.random()-0.5)*10, dy:(Math.random()-0.5)*10, life:1});
        
        if (score >= 50 && !bossTriggered) { bossTriggered = true; ball.r = 60; bgFlash = 0.5; }
    }

    if (Math.random() < 0.007) {
        let rand = Math.random();
        let type = 'WIDE';
        if (rand > 0.4) type = 'SLOW';
        if (rand > 0.8) type = 'SPEED';
        powerUps.push({ x: Math.random()*(canvas.width-20), y: -20, type: type });
    }

    powerUps.forEach((p, i) => {
        p.y += 4;
        if (p.y > paddle.y && p.x > paddle.x && p.x < paddle.x + paddle.w) {
            if (p.type === 'WIDE') { paddle.targetW = 240; document.getElementById("event-msg").innerText="ULTRA WIDE"; setTimeout(()=>{paddle.targetW=paddle.baseW; document.getElementById("event-msg").innerText="NORMAL";}, 5000); }
            else if (p.type === 'SLOW') { slowMo = 300; document.getElementById("event-msg").innerText="SLOW MO"; setTimeout(()=>{document.getElementById("event-msg").innerText="NORMAL";}, 5000); }
            else if (p.type === 'SPEED') { speedUp = 300; document.getElementById("event-msg").innerText="TURBO (2x PTS)"; bgFlash = 0.3; setTimeout(()=>{document.getElementById("event-msg").innerText="NORMAL";}, 5000); }
            powerUps.splice(i, 1);
        }
    });

    particles.forEach((p, i) => { p.x += p.dx; p.y += p.dy; p.life -= 0.03; if(p.life <= 0) particles.splice(i,1); });
    if(ball.y > canvas.height + 50) { gameActive = false; endGame(); }
}

function render() {
    ctx.fillStyle = "#000"; ctx.fillRect(0, 0, canvas.width, canvas.height);
    if (bgFlash > 0) { ctx.fillStyle = `rgba(255, 0, 0, ${bgFlash})`; ctx.fillRect(0,0,canvas.width,canvas.height); }
    if (speedUp > 0) { ctx.fillStyle = `rgba(255, 215, 0, ${Math.sin(Date.now()/100)*0.1})`; ctx.fillRect(0,0,canvas.width,canvas.height); }
    
    ctx.save();
    if (shake > 0) { ctx.translate((Math.random()-0.5)*shake, (Math.random()-0.5)*shake); shake *= 0.8; }
    particles.forEach(p => { ctx.globalAlpha = p.life; ctx.fillStyle = "#ffd700"; ctx.fillRect(p.x, p.y, 3, 3); });
    ctx.globalAlpha = 1;
    
    powerUps.forEach(p => { 
        ctx.fillStyle = p.type === 'WIDE' ? '#00ccff' : p.type === 'SLOW' ? '#00ff66' : '#ff0000';
        ctx.beginPath(); ctx.arc(p.x, p.y, 12, 0, Math.PI*2); ctx.fill(); 
    });

    if(paddleImg.complete) {
        paddle.w += (paddle.targetW - paddle.w) * 0.1;
        ctx.drawImage(paddleImg, paddle.x, paddle.y, paddle.w, paddle.w * (paddleImg.naturalHeight/paddleImg.naturalWidth));
    }
    
    ctx.save();
    ctx.translate(ball.x, ball.y); ctx.rotate(wobble);
    ctx.drawImage(eggImg, -ball.r, -ball.r, ball.r*2, ball.r*2);
    ctx.restore(); ctx.restore();
    if(gameActive) requestAnimationFrame(render);
}

function endGame() {
    clearInterval(timerInterval);
    const finalScore = score + Math.floor(seconds / 2);
    document.getElementById("overlay").style.display = "block";
    document.getElementById("popup").style.display = "block";
    document.getElementById("final-display").innerText = finalScore;

    const minTop3 = top3Scores.length < 3 ? 0 : top3Scores[top3Scores.length - 1].score;
    if (finalScore > minTop3) {
        document.getElementById("save-area").style.display = "block";
        document.getElementById("retryBtn").style.display = "none";
    }

    document.getElementById("saveBtn").onclick = async () => {
        const wallet = document.getElementById("walletAddr").value.trim();
        if (wallet.length < 5) return;
        await fetch(`${SUPABASE_URL}/rest/v1/leaderboard`, {
            method: 'POST',
            headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ wallet: wallet, score: finalScore })
        });
        window.location.reload();
    };
    document.getElementById("retryBtn").onclick = () => window.location.reload();
}

function handleInput(e) {
    if (!started) { 
        started = true; 
        timerInterval = setInterval(() => { if(gameActive) { seconds++; document.getElementById("timer").innerText = seconds + "s"; } }, 1000);
    }
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    paddle.x = clientX - paddle.w/2;
}

window.addEventListener("mousemove", handleInput);
window.addEventListener("touchstart", handleInput);
window.addEventListener("touchmove", (e) => { handleInput(e); e.preventDefault(); }, {passive:false});

loadScores(); resize(); render();
setInterval(update, 1000/60);
</script>
</body>
</html>
