<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, viewport-fit=cover">
    <title>PimpPong | BOSS SOUND FIXED</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&display=swap');
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; touch-action: none; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100dvh; background: #000; color: #ffd700; font-family: 'Orbitron', sans-serif; overflow: hidden; }
        canvas { display: block; width: 100%; height: 100%; background: #000; }
        .header { position: absolute; top: 0; width: 100%; padding: 15px; background: rgba(0,0,0,0.8); z-index: 100; border-bottom: 2px solid #ffd700; text-align: center; pointer-events: none; }
        #leaderboard { position: absolute; bottom: 15px; left: 15px; z-index: 20; background: rgba(0, 0, 0, 0.7); padding: 5px; border-radius: 8px; border: 1px solid rgba(255, 215, 0, 0.4); width: 150px; }
        table { width: 100%; font-size: 0.6rem; color: #fff; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; }
        #popup { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #0a0a0a; border: 3px solid #ffd700; padding: 30px; z-index: 1100; border-radius: 20px; width: 85%; max-width: 380px; text-align: center; }
        .main-btn { background: #ffd700; color: #000; border: none; padding: 15px; font-weight: 900; width: 100%; cursor: pointer; border-radius: 10px; font-family: 'Orbitron'; margin-top: 10px; }
        #event-msg { font-size: 0.7rem; color: #00ff66; height: 15px; font-weight: bold; text-transform: uppercase; }
    </style>
</head>
<body>

<div class="header">
    <div id="event-msg">MUSIC READY</div>
    <div style="font-size: 1.1rem;">SCORE: <span id="score">0</span> | BEST: <span id="high">0</span></div>
</div>

<canvas id="gameCanvas"></canvas>

<div id="leaderboard">
    <table><tbody id="leader-rows"></tbody></table>
</div>

<div class="overlay" id="overlay"></div>
<div id="popup">
    <h2>GAME OVER</h2>
    <h1 id="final-score" style="font-size: 3.5rem; color: #ffd700;">0</h1>
    <button id="actionBtn" class="main-btn">TRY AGAIN</button>
</div>

<script>
const SUPABASE_URL = 'https://jmknzhsmlwqwzxguxfor.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impta256aHNtbHdxd3p4Z3V4Zm9yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzMTk4ODQsImV4cCI6MjA4Mzg5NTg4NH0.ZKZ-lTZmc6HoLoAC-MuyejyQCL4WM9ZMgEU_x-yH_L0';
const PADDLE_URL = 'https://i.ibb.co/s06v3BX/image-8.png';
const EGG_URL = 'https://i.ibb.co/VYbXg81b/16220.png';

const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const paddleImg = new Image(); paddleImg.src = PADDLE_URL;
const eggImg = new Image(); eggImg.src = EGG_URL;

// --- AUDIO ENGINE ---
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
const masterGain = audioCtx.createGain();
masterGain.gain.value = 0.25; 
masterGain.connect(audioCtx.destination);

let beatStarted = false;

function playKick(t) {
    const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
    osc.frequency.setValueAtTime(100, t); osc.frequency.exponentialRampToValueAtTime(0.01, t + 0.3);
    gain.gain.setValueAtTime(0.5, t); gain.gain.exponentialRampToValueAtTime(0.01, t + 0.3);
    osc.connect(gain); gain.connect(masterGain);
    osc.start(t); osc.stop(t + 0.3);
}

function playBeep(f, d) {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
    osc.type = 'sine'; osc.frequency.setValueAtTime(f, audioCtx.currentTime);
    gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + d);
    osc.connect(gain); gain.connect(masterGain);
    osc.start(); osc.stop(audioCtx.currentTime + d);
}

// --- GAME STATE ---
let score = 0, gameActive = true, particles = [], powerUps = [];
let paddle = { x: 100, y: 0, w: 140, h: 40, targetW: 140, baseW: 140 };
let ball = { x: 150, y: 150, r: 20, dx: 4, dy: 4, bossHP: 0 };
let shake = 0, slowMo = 0, bgFlash = 0, wobble = 0;
let bossTriggered = false; // Neu: Verhindert Mehrfach-Sound bei Score 50

async function loadScores() {
    try {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/leaderboard?select=wallet,score&order=score.desc&limit=3`, {
            headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
        });
        const data = await res.json();
        if (data) {
            document.getElementById("leader-rows").innerHTML = data.map((e,i)=>`<tr><td>${i+1}.</td><td>${e.wallet.substring(0,5)}</td><td align="right">${e.score}</td></tr>`).join('');
            if(data[0]) document.getElementById("high").innerText = data[0].score;
        }
    } catch(e) {}
}

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    paddle.y = canvas.height - 180;
}
window.addEventListener('resize', resize);
paddleImg.onload = resize;

function update() {
    if(!gameActive) return;
    if (slowMo > 0) slowMo--;
    if (bgFlash > 0) bgFlash -= 0.02;

    const currentDt = slowMo > 0 ? 0.45 : 1;
    
    ball.dx = Math.max(-12, Math.min(12, ball.dx));
    ball.x += (ball.dx + Math.sin(wobble) * 1.5) * currentDt;
    ball.y += ball.dy * currentDt;
    wobble += 0.1;

    // Wall Collision
    if(ball.x <= ball.r) { ball.dx = Math.abs(ball.dx); ball.x = ball.r; playBeep(200, 0.05); }
    if(ball.x >= canvas.width - ball.r) { ball.dx = -Math.abs(ball.dx); ball.x = canvas.width - ball.r; playBeep(200, 0.05); }
    if(ball.y <= ball.r) { ball.dy = Math.abs(ball.dy); ball.y = ball.r; }

    // Paddle Collision
    if (ball.y + ball.r > paddle.y && ball.y - ball.r < paddle.y + paddle.h && ball.x > paddle.x && ball.x < paddle.x + paddle.w) {
        let hitPos = (ball.x - (paddle.x + paddle.w/2)) / (paddle.w/2);
        ball.dx = hitPos * 7 + (Math.random()-0.5)*2;
        ball.dy = -Math.abs(ball.dy) * (score < 60 ? 1.04 : 1.01);
        ball.y = paddle.y - ball.r;
        score++;
        document.getElementById("score").innerText = score;
        
        // Normaler Treffersound (außer bei Boss-Trigger)
        if (score !== 50) playBeep(500, 0.1); 
        shake = 6;
        
        for(let i=0; i<6; i++) particles.push({x: ball.x, y: ball.y, dx:(Math.random()-0.5)*5, dy:(Math.random()-0.5)*5, life:1});

        // FIX: BOSS TRIGGER NUR EINMAL AUSFÜHREN
        if (score === 50 && !bossTriggered) { 
            bossTriggered = true;
            ball.bossHP = 3; 
            ball.r = 60; 
            bgFlash = 0.5; 
            document.getElementById("event-msg").innerText = "BOSS FIGHT!"; 
            playBeep(150, 0.6); // Tiefer, angenehmerer Boss-Sound
        }
        
        if (score > 70) paddle.baseW = Math.max(70, paddle.baseW - 1);
        paddle.targetW = paddle.baseW;
    }

    // PowerUps
    if (Math.random() < 0.005) powerUps.push({ x: Math.random()*(canvas.width-20), y: -20, type: Math.random()>0.5?'WIDE':'SLOW' });
    powerUps.forEach((p, i) => {
        p.y += 3.5;
        if (p.y > paddle.y && p.x > paddle.x && p.x < paddle.x + paddle.w) {
            playBeep(800, 0.1);
            if (p.type === 'WIDE') { paddle.targetW = 220; document.getElementById("event-msg").innerText = "ULTRA WIDE!"; setTimeout(()=>{paddle.targetW=paddle.baseW; document.getElementById("event-msg").innerText="";}, 5000); }
            else { slowMo = 200; document.getElementById("event-msg").innerText = "SLOW MOTION!"; setTimeout(()=>{document.getElementById("event-msg").innerText="";}, 4000); }
            powerUps.splice(i, 1);
        } else if (p.y > canvas.height) powerUps.splice(i, 1);
    });

    particles.forEach((p, i) => { p.x += p.dx; p.y += p.dy; p.life -= 0.04; if(p.life <= 0) particles.splice(i,1); });

    if(ball.y > canvas.height + 100) { gameActive = false; showPopup(); }
}

function render() {
    ctx.fillStyle = "#000"; ctx.fillRect(0, 0, canvas.width, canvas.height);
    if (bgFlash > 0) { ctx.fillStyle = `rgba(255, 0, 0, ${bgFlash})`; ctx.fillRect(0,0,canvas.width,canvas.height); }

    ctx.save();
    if (shake > 0) { ctx.translate((Math.random()-0.5)*shake, (Math.random()-0.5)*shake); shake *= 0.8; }

    particles.forEach(p => { ctx.globalAlpha = p.life; ctx.fillStyle = "#ffd700"; ctx.fillRect(p.x, p.y, 3, 3); });
    ctx.globalAlpha = 1;

    powerUps.forEach(p => { ctx.fillStyle = p.type === 'WIDE' ? '#00ccff' : '#00ff66'; ctx.beginPath(); ctx.arc(p.x, p.y, 10, 0, Math.PI*2); ctx.fill(); });

    if(paddleImg.complete) {
        paddle.w += (paddle.targetW - paddle.w) * 0.1;
        paddle.h = paddle.w * (paddleImg.naturalHeight / paddleImg.naturalWidth);
        ctx.drawImage(paddleImg, paddle.x, paddle.y, paddle.w, paddle.h);
    }

    ctx.save();
    ctx.translate(ball.x, ball.y); ctx.rotate(wobble);
    if(ball.bossHP > 0) { ctx.shadowBlur = 15; ctx.shadowColor = "red"; }
    ctx.drawImage(eggImg, -ball.r, -ball.r, ball.r*2, ball.r*2);
    ctx.restore();

    ctx.restore();
    if(gameActive) requestAnimationFrame(render);
}

function showPopup() {
    document.getElementById("overlay").style.display = "block";
    document.getElementById("popup").style.display = "block";
    document.getElementById("final-score").innerText = score;
    document.getElementById("actionBtn").onclick = () => window.location.reload();
}

function handleInput(e) {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    if (!beatStarted) { beatStarted = true; setInterval(() => playKick(audioCtx.currentTime), 468); }
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    paddle.x = clientX - paddle.w/2;
}

window.addEventListener("mousemove", handleInput);
window.addEventListener("touchstart", handleInput);
window.addEventListener("touchmove", (e) => { handleInput(e); e.preventDefault(); }, {passive:false});

loadScores(); resize(); render();
setInterval(update, 1000/60);
</script>
</body>
</html>
